services:
  # Service Registry (Eureka Server)
  service-registry:
    build:
      context: ./service-registry
      dockerfile: Dockerfile
    container_name: lifepill-service-registry
    ports:
      - "8761:8761"
    environment:
      - EUREKA_PORT=8761
      - EUREKA_USERNAME=admin
      - EUREKA_PASSWORD=${EUREKA_PASSWORD:-admin}
      - EUREKA_SELF_PRESERVATION=true
      - LOG_PATH=/logs
    volumes:
      - ./logs/service-registry:/logs
    networks:
      - lifepill-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Config Server
  config-server:
    build:
      context: ./config-server
      dockerfile: Dockerfile
    container_name: lifepill-config-server
    ports:
      - "8888:8888"
    environment:
      - CONFIG_SERVER_PORT=8888
      - CONFIG_SERVER_USERNAME=configuser
      - CONFIG_SERVER_PASSWORD=${CONFIG_SERVER_PASSWORD:-configsecret}
      - EUREKA_URI=http://admin:${EUREKA_PASSWORD:-admin}@service-registry:8761/eureka/
      - LOG_PATH=/logs
    volumes:
      - ./logs/config-server:/logs
      - ./config-repo:/config-repo
    networks:
      - lifepill-network
    depends_on:
      service-registry:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8888/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # API Gateway
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: lifepill-api-gateway
    ports:
      - "9191:9191"
    environment:
      - API_GATEWAY_PORT=9191
      - EUREKA_URI=http://admin:${EUREKA_PASSWORD:-admin}@service-registry:8761/eureka/
      - CONFIG_SERVER_ENABLED=true
      - CONFIG_SERVER_URI=http://config-server:8888
      - CONFIG_SERVER_USERNAME=configuser
      - CONFIG_SERVER_PASSWORD=${CONFIG_SERVER_PASSWORD:-configsecret}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - CORS_METHODS=${CORS_METHODS:-GET,POST,PUT,DELETE,OPTIONS,PATCH}
      - CORS_HEADERS=${CORS_HEADERS:-*}
      - LOG_PATH=/logs
      # Redis Configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # Distributed Tracing
      - TRACING_ENABLED=${TRACING_ENABLED:-true}
      - ZIPKIN_ENDPOINT=http://zipkin:9411/api/v2/spans
      - TRACING_SAMPLING_PROBABILITY=${TRACING_SAMPLING_PROBABILITY:-1.0}
    volumes:
      - ./logs/api-gateway:/logs
    networks:
      - lifepill-network
    depends_on:
      service-registry:
        condition: service_healthy
      config-server:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9191/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # User Auth Service
  user-auth:
    build:
      context: ./user-auth
      dockerfile: Dockerfile
    container_name: lifepill-user-auth
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - DB_URL=jdbc:postgresql://postgres:5432/mobile_user_auth_db
      - DB_USERNAME=${DB_USERNAME:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      - JWT_SECRET=${JWT_SECRET}
      - EUREKA_URI=http://admin:${EUREKA_PASSWORD:-admin}@service-registry:8761/eureka/
      - CONFIG_SERVER_ENABLED=true
      - CONFIG_SERVER_URI=http://config-server:8888
      - CONFIG_SERVER_USERNAME=configuser
      - CONFIG_SERVER_PASSWORD=${CONFIG_SERVER_PASSWORD:-configsecret}
      - MAIL_HOST=${MAIL_HOST:-smtp.gmail.com}
      - MAIL_PORT=${MAIL_PORT:-587}
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - LOG_PATH=/logs
      # CORS Configuration
      - CORS_ENABLED=${CORS_ENABLED:-true}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - CORS_METHODS=${CORS_METHODS:-GET,POST,PUT,DELETE,OPTIONS,PATCH}
      - CORS_HEADERS=${CORS_HEADERS:-*}
      - CORS_MAX_AGE=${CORS_MAX_AGE:-86400}
      - CORS_ALLOW_CREDENTIALS=${CORS_ALLOW_CREDENTIALS:-true}
      # Distributed Tracing
      - TRACING_ENABLED=${TRACING_ENABLED:-true}
      - ZIPKIN_ENDPOINT=http://zipkin:9411/api/v2/spans
      - TRACING_SAMPLING_PROBABILITY=${TRACING_SAMPLING_PROBABILITY:-1.0}
      # Swagger Configuration
      - SWAGGER_SERVER_URL=${SWAGGER_SERVER_URL:-http://34.9.86.185:8080/api}
      # Flyway Migration
      - FLYWAY_ENABLED=${FLYWAY_ENABLED:-true}
      - JPA_DDL_AUTO=update
    volumes:
      - ./logs/user-auth:/logs
    networks:
      - lifepill-network
    depends_on:
      service-registry:
        condition: service_healthy
      config-server:
        condition: service_healthy
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/api/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: lifepill-postgres
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${DB_USERNAME:-postgres}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-postgres}
      - POSTGRES_DB=mobile_user_auth_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    networks:
      - lifepill-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis (for API Gateway rate limiting)
  redis:
    image: redis:7-alpine
    container_name: lifepill-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - lifepill-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Prometheus (Metrics Collection)
  prometheus:
    image: prom/prometheus:latest
    container_name: lifepill-prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    networks:
      - lifepill-network
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'

  # Grafana (Metrics Visualization)
  grafana:
    image: grafana/grafana:latest
    container_name: lifepill-grafana
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning
    networks:
      - lifepill-network
    depends_on:
      - prometheus

  # Zipkin (Distributed Tracing)
  zipkin:
    image: openzipkin/zipkin:latest
    container_name: lifepill-zipkin
    ports:
      - "9411:9411"
    environment:
      - STORAGE_TYPE=mem
      - JAVA_OPTS=-Xms256m -Xmx512m
    networks:
      - lifepill-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9411/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # Patient Customer Service
  patient-customer-service:
    build:
      context: ./patient-customer-service
      dockerfile: Dockerfile
    container_name: lifepill-patient-customer-service
    ports:
      - "8070:8070"
    environment:
      - PORT=8070
      - DB_DATABASE_URL=jdbc:postgresql://postgres:5432/customer_service_db
      - DB_USERNAME=${DB_USERNAME:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      - MDB_CONNECTION_STRING=${MONGODB_URI:-mongodb://mongodb:27017/lifepill_customer}
      - STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY}
      - EUREKA_URI=http://admin:${EUREKA_PASSWORD:-admin}@service-registry:8761/eureka/
      - LOG_PATH=/logs
      # CORS Configuration
      - CORS_ENABLED=${CORS_ENABLED:-true}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - CORS_METHODS=${CORS_METHODS:-GET,POST,PUT,DELETE,OPTIONS,PATCH}
      - CORS_HEADERS=${CORS_HEADERS:-*}
      - CORS_MAX_AGE=${CORS_MAX_AGE:-86400}
      - CORS_ALLOW_CREDENTIALS=${CORS_ALLOW_CREDENTIALS:-false}
      # Distributed Tracing
      - TRACING_ENABLED=${TRACING_ENABLED:-true}
      - ZIPKIN_ENDPOINT=http://zipkin:9411/api/v2/spans
      - TRACING_SAMPLING_PROBABILITY=${TRACING_SAMPLING_PROBABILITY:-1.0}
      # Swagger Configuration
      - SWAGGER_SERVER_URL=${CUSTOMER_SERVICE_SWAGGER_URL:-http://34.9.86.185:8070}
      # Flyway Migration
      - FLYWAY_ENABLED=${FLYWAY_ENABLED:-true}
      - JPA_DDL_AUTO=update
    volumes:
      - ./logs/patient-customer-service:/logs
    networks:
      - lifepill-network
    depends_on:
      service-registry:
        condition: service_healthy
      postgres:
        condition: service_healthy
      mongodb:
        condition: service_healthy
      zipkin:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8070/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # MongoDB (for Patient Customer Service)
  mongodb:
    image: mongo:6-jammy
    container_name: lifepill-mongodb
    ports:
      - "27017:27017"
    environment:
      - MONGO_INITDB_DATABASE=lifepill_customer
    volumes:
      - mongodb_data:/data/db
    networks:
      - lifepill-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Branch Service
  branch-service:
    build:
      context: ./branch-service
      dockerfile: Dockerfile
    container_name: lifepill-branch-service
    ports:
      - "8081:8081"
    environment:
      - PORT=8081
      - DB_URL=jdbc:postgresql://postgres:5432/branch_service_db
      - DB_USERNAME=${DB_USERNAME:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      - EUREKA_URI=http://admin:${EUREKA_PASSWORD:-admin}@service-registry:8761/eureka/
      - ZIPKIN_ENDPOINT=http://zipkin:9411/api/v2/spans
      - LOG_PATH=/logs
      # Flyway Migration
      - FLYWAY_ENABLED=${FLYWAY_ENABLED:-true}
      - JPA_DDL_AUTO=update
      # CORS Configuration
      - CORS_ENABLED=${CORS_ENABLED:-true}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - CORS_METHODS=${CORS_METHODS:-GET,POST,PUT,DELETE,OPTIONS,PATCH}
      - CORS_HEADERS=${CORS_HEADERS:-*}
      # Tracing
      - TRACING_ENABLED=true
      - TRACING_SAMPLING_PROBABILITY=1.0
    volumes:
      - ./logs/branch-service:/logs
    networks:
      - lifepill-network
    depends_on:
      service-registry:
        condition: service_healthy
      postgres:
        condition: service_healthy
      zipkin:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Inventory Service
  inventory-service:
    build:
      context: ./inventory-service
      dockerfile: Dockerfile
    container_name: lifepill-inventory-service
    ports:
      - "8082:8082"
    environment:
      - PORT=8082
      - DB_HOST=postgres
      - DB_PORT=5432
      - INVENTORY_DB_NAME=inventory_service_db
      - DB_USERNAME=${DB_USERNAME:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      - EUREKA_HOST=service-registry
      - EUREKA_PORT=8761
      - EUREKA_USER=admin
      - EUREKA_PASSWORD=${EUREKA_PASSWORD:-admin}
      - ZIPKIN_HOST=zipkin
      - ZIPKIN_PORT=9411
      - LOG_PATH=/logs
      # Flyway Migration
      - FLYWAY_ENABLED=${FLYWAY_ENABLED:-true}
      - JPA_DDL_AUTO=update
      # CORS Configuration
      - CORS_ENABLED=${CORS_ENABLED:-true}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - CORS_METHODS=${CORS_METHODS:-GET,POST,PUT,DELETE,OPTIONS,PATCH}
      - CORS_HEADERS=${CORS_HEADERS:-*}
    volumes:
      - ./logs/inventory-service:/logs
    networks:
      - lifepill-network
    depends_on:
      service-registry:
        condition: service_healthy
      postgres:
        condition: service_healthy
      zipkin:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8082/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # Order Service (formerly POS System) - Handles orders, payments, transactions
  order-service:
    build:
      context: ./pharmacy-pos-main-backend/pos-system
      dockerfile: Dockerfile
    container_name: lifepill-order-service
    ports:
      - "8086:8086"
    environment:
      - PORT=8086
      - SPRING_PROFILES_ACTIVE=docker
      # Database Configuration
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=order_service_db
      - DB_USERNAME=${DB_USERNAME:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      # Eureka Configuration
      - EUREKA_HOST=service-registry
      - EUREKA_PORT=8761
      - EUREKA_USER=admin
      - EUREKA_PASSWORD=${EUREKA_PASSWORD:-admin}
      # Zipkin Configuration
      - ZIPKIN_HOST=zipkin
      - ZIPKIN_PORT=9411
      # Redis Configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # JWT Configuration
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRATION=${JWT_EXPIRATION:-86400000}
      - JWT_REFRESH_EXPIRATION=${JWT_REFRESH_EXPIRATION:-604800000}
      # AWS S3 Configuration (optional)
      - AWS_ACCESS_KEY=${AWS_ACCESS_KEY:-}
      - AWS_SECRET_KEY=${AWS_SECRET_KEY:-}
      - AWS_REGION=${AWS_REGION:-us-east-1}
      - AWS_S3_BUCKET=${AWS_S3_BUCKET:-lifepill-pos}
      # Mail Configuration
      - MAIL_HOST=${MAIL_HOST:-smtp.gmail.com}
      - MAIL_PORT=${MAIL_PORT:-587}
      - MAIL_USERNAME=${MAIL_USERNAME:-}
      - MAIL_PASSWORD=${MAIL_PASSWORD:-}
      # CORS Configuration
      - CORS_ENABLED=${CORS_ENABLED:-true}
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
      - CORS_METHODS=${CORS_METHODS:-GET,POST,PUT,DELETE,OPTIONS,PATCH}
      - CORS_HEADERS=${CORS_HEADERS:-*}
      - LOG_PATH=/logs
    volumes:
      - ./logs/order-service:/logs
      - order_uploads:/app/uploads
    networks:
      - lifepill-network
    depends_on:
      service-registry:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      zipkin:
        condition: service_healthy
      branch-service:
        condition: service_healthy
      inventory-service:
        condition: service_healthy
      identity-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8086/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # Employee Identity Service
  identity-service:
    build:
      context: ./employee-identity-service
      dockerfile: Dockerfile
    container_name: lifepill-identity-service
    ports:
      - "8085:8085"
    environment:
      - PORT=8085
      # Database Configuration
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_NAME=identity_service_db
      - DB_USERNAME=${DB_USERNAME:-postgres}
      - DB_PASSWORD=${DB_PASSWORD:-postgres}
      # Eureka Configuration
      - EUREKA_URI=http://admin:${EUREKA_PASSWORD:-admin}@service-registry:8761/eureka/
      # Zipkin Configuration
      - ZIPKIN_ENDPOINT=http://zipkin:9411/api/v2/spans
      # Redis Configuration
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      # JWT Configuration
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ACCESS_TOKEN_EXPIRATION=${JWT_EXPIRATION:-86400000}
      - JWT_REFRESH_TOKEN_EXPIRATION=${JWT_REFRESH_EXPIRATION:-604800000}
      # Tracing
      - TRACING_ENABLED=true
      - TRACING_SAMPLING_PROBABILITY=1.0
      - LOG_PATH=/logs
      # Flyway Migration
      - FLYWAY_ENABLED=${FLYWAY_ENABLED:-true}
      - JPA_DDL_AUTO=update
    volumes:
      - ./logs/identity-service:/logs
    networks:
      - lifepill-network
    depends_on:
      service-registry:
        condition: service_healthy
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      zipkin:
        condition: service_healthy
      branch-service:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8085/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

networks:
  lifepill-network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  prometheus_data:
  grafana_data:
  mongodb_data:
  order_uploads:
